import{d as P,u as p,r as g,a as f,b0 as X}from"./vendor-BxNawP4f.js";import"./index-DyxCg8e9.js";const h={MAX_ITEMS:100,FAVORITE_MAX_ITEMS:50,RECENT_MAX_ITEMS:20},m=new Worker(new URL("/assets/calculator.worker-Bx0h5d4l.js",import.meta.url),{type:"module"}),j=P("calculator",()=>{const o=p("calc_history",[]),s=p("calc_favorites",new Set),n=p("calc_recent_searches",[]),S=g(null),l=g(!1),I=g(null),y=f(()=>[...o.value].sort((e,t)=>t.timestamp-e.timestamp)),L=f(()=>{const e=new Map;return o.value.forEach(t=>{var r;const a=new Date(t.timestamp).toLocaleDateString();e.has(a)||e.set(a,[]),(r=e.get(a))==null||r.push(t)}),e}),_=f(()=>o.value.filter(e=>s.value.has(e.id))),v={itemHeight:60,bufferSize:5,pageSize:20},E=e=>{const t=e*v.pageSize,a=t+v.pageSize;return y.value.slice(t,a)},A=f(()=>e=>{const t=e+1;return E(t)}),w=f(()=>{const e=new Map;return o.value.forEach(t=>{const a=new Date(t.timestamp).toLocaleDateString();e.has(a)||e.set(a,{items:[],total:0,loaded:0});const r=e.get(a);r.total++,r.items.length<v.pageSize&&(r.items.push(t),r.loaded++)}),e}),O=(e,t)=>{const a=w.value.get(e);if(!a||a.loaded>=a.total)return;const r=a.loaded,i=o.value.filter(c=>new Date(c.timestamp).toLocaleDateString()===e).slice(r,r+t);a.items.push(...i),a.loaded+=i.length};let d=null;const C=()=>{d||(d=window.setInterval(()=>{const e=o.value.length,t=Math.floor(e*.8);e>=t&&A.value(Math.floor(e/v.pageSize))},1e3))},R=()=>{d&&(clearInterval(d),d=null)};C(),X(()=>{R()}),m.onmessage=e=>{const{type:t,data:a,request:r}=e.data;switch(t){case"CALCULATION_COMPLETE":S.value=a,M(a,r),l.value=!1;break;case"CALCULATION_ERROR":console.error("计算错误:",a),l.value=!1;break}};const H=async e=>{try{return l.value=!0,T(JSON.stringify(e)),m.postMessage({type:"CALCULATE",data:e}),new Promise((t,a)=>{const r=setTimeout(()=>{a(new Error("计算超时")),l.value=!1},3e4);m.onmessage=i=>{clearTimeout(r);const{type:c,data:u}=i.data;c==="CALCULATION_COMPLETE"?t(u):a(new Error(u)),l.value=!1}})}catch(t){throw console.error("计算运费失败:",t),l.value=!1,t}},M=(e,t)=>{const a={id:z(),request:t,...e,timestamp:Date.now()};if(o.value.unshift(a),o.value.length>h.MAX_ITEMS){const r=new Set(s.value),i=o.value.filter(u=>!r.has(u.id)),c=o.value.filter(u=>r.has(u.id));o.value=[...c,...i.slice(0,h.MAX_ITEMS-c.length)]}return a.id},T=e=>{const t=n.value.indexOf(e);t>-1&&n.value.splice(t,1),n.value.unshift(e),n.value.length>h.RECENT_MAX_ITEMS&&(n.value=n.value.slice(0,h.RECENT_MAX_ITEMS))},D=e=>{if(s.value.has(e))s.value.delete(e);else{if(s.value.size>=h.FAVORITE_MAX_ITEMS){const t=Array.from(s.value)[0];s.value.delete(t)}s.value.add(e)}},x=(e=!0)=>{e?o.value=o.value.filter(t=>s.value.has(t.id)):(o.value=[],s.value.clear())},N=e=>{o.value=o.value.filter(t=>t.id!==e),s.value.delete(e)},b=()=>{const e={history:o.value,favorites:Array.from(s.value),recentSearches:n.value,exportDate:new Date().toISOString()},t=new Blob([JSON.stringify(e)],{type:"application/json"}),a=URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.download=`calculation-history-${new Date().toISOString()}.json`,r.click(),URL.revokeObjectURL(a)},U=async e=>{try{const t=await e.text(),a=JSON.parse(t);return a.history&&Array.isArray(a.history)&&(o.value=a.history),a.favorites&&Array.isArray(a.favorites)&&(s.value=new Set(a.favorites)),a.recentSearches&&Array.isArray(a.recentSearches)&&(n.value=a.recentSearches),!0}catch(t){return console.error("导入历史记录失败:",t),!1}},z=()=>`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return{history:o,favorites:s,recentSearches:n,currentResult:S,loading:l,error:I,sortedHistory:y,groupedHistory:L,favoriteHistory:_,addHistory:M,addRecentSearch:T,toggleFavorite:D,clearHistory:x,deleteHistory:N,exportHistory:b,importHistory:U,calculate:H,virtualListConfig:v,loadHistoryPage:E,preloadNextPage:A,virtualGroupedHistory:w,loadMoreGroupItems:O}});export{j as u};
