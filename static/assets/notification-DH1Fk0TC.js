var W=Object.defineProperty;var G=(a,i,o)=>i in a?W(a,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[i]=o;var h=(a,i,o)=>G(a,typeof i!="symbol"?i+"":i,o);import{d as D,bS as d,w as K,a as p}from"./vendor-BxNawP4f.js";import{g as U,p as S,d as V,b as X}from"./index-DyxCg8e9.js";const m={base:"/api/v1/notifications",detail:a=>`/api/v1/notifications/${a}`,markAsRead:a=>`/api/v1/notifications/${a}/read`,markAllAsRead:"/api/v1/notifications/mark-all-read",clearRead:"/api/v1/notifications/clear-read",unreadCount:"/api/v1/notifications/unread-count",settings:"/api/v1/notification-settings"},E=async a=>{const{data:i}=await U(m.base,{params:a});return i},x=async(a,i)=>{const{data:o}=await X(m.detail(a),i);return o},Y=async a=>{await V(m.detail(a))},Z=async a=>{const{data:i}=await S(m.markAsRead(a));return i},tt=async()=>{const{data:a}=await S(m.markAllAsRead);return a},et=async()=>{const{data:a}=await S(m.clearRead);return a},at=D("notificationFilter",{state:()=>({filter:d("notificationFilter",{search:"",module:null,type:null,read:null,startDate:null,endDate:null})}),actions:{setFilter(a){this.filter={...this.filter,...a}},resetFilter(){this.filter={search:"",module:null,type:null,read:null,startDate:null,endDate:null}}}}),y=D("notificationConfig",{state:()=>({config:d("notificationConfig",{maxCount:100,expirationDays:30,soundEnabled:!0,desktopNotification:!0,groupByModule:!0,autoCleanup:!0})}),actions:{updateConfig(a){this.config={...this.config,...a}},resetConfig(){this.config={maxCount:100,expirationDays:30,soundEnabled:!0,desktopNotification:!0,groupByModule:!0,autoCleanup:!0}}}});class it{constructor(){h(this,"audioCache",new Map);h(this,"notificationPermission","default");h(this,"notificationQueue",[]);h(this,"isProcessingQueue",!1);h(this,"soundConfig",{success:"/sounds/success.mp3",warning:"/sounds/warning.mp3",info:"/sounds/info.mp3",error:"/sounds/error.mp3"});Object.entries(this.soundConfig).forEach(([i,o])=>{const s=new Audio(o);s.preload="auto",this.audioCache.set(i,s)}),"Notification"in window&&Notification.requestPermission().then(i=>{this.notificationPermission=i,i==="granted"&&this.processNotificationQueue()})}async playSound(i){try{let o=this.audioCache.get(i);o||(o=new Audio(i),this.audioCache.set(i,o)),await o.play()}catch(o){console.error("播放通知音效失败:",o)}}async showDesktopNotification(i){if("Notification"in window)try{await Notification.requestPermission()==="granted"&&new Notification(i.title,{body:i.message,icon:"/icons/notification.png"})}catch(o){console.error("显示桌面通知失败:",o)}}async processNotificationQueue(){if(!(this.isProcessingQueue||this.notificationQueue.length===0)){this.isProcessingQueue=!0;try{for(;this.notificationQueue.length>0;){const i=this.notificationQueue.shift();i&&(await this.showDesktopNotification(i),await new Promise(o=>setTimeout(o,500)))}}finally{this.isProcessingQueue=!1}}}async handleNewNotification(i){const o=y(),{soundEnabled:s,desktopNotification:u}=o.config;if(s){const l=i.type==="error"?"error":i.type==="warning"?"warning":i.type==="system"?"info":"success";await this.playSound(this.soundConfig[l])}u&&(document.visibilityState==="visible"?await this.showDesktopNotification(i):(this.notificationQueue.push(i),await this.processNotificationQueue()))}dispose(){this.audioCache.forEach(i=>{i.src=""}),this.audioCache.clear(),this.notificationQueue=[]}}const C=new it;function rt(a){const i=new Date(a),s=new Date().getTime()-i.getTime(),u=Math.floor(s/6e4),l=Math.floor(u/60),c=Math.floor(l/24);return u<1?"刚刚":u<60?`${u}分钟前`:l<24?`${l}小时前`:c<7?`${c}天前`:i.toLocaleDateString()}const ct=D("notification",()=>{const a=d("notifications",[]),i=d("notification_loading",!1),o=d("notification_error",null),s=d("notification_total",0),u=d("notification_ws_connected",!1),l=d("lastNotificationSync",0),c=d("notification_settings",{maxCount:50,expirationDays:7,soundEnabled:!0,desktopNotification:!0,groupByModule:!0,autoCleanup:!0}),A={success:"/sounds/success.mp3",warning:"/sounds/warning.mp3",error:"/sounds/error.mp3",info:"/sounds/info.mp3",system:"/sounds/system.mp3",business:"/sounds/business.mp3"};K(()=>a.value.length,()=>{y().config.autoCleanup&&b()});const M=p(()=>a.value.filter(e=>!e.read).length),Q=p(()=>[...new Set(a.value.map(e=>e.module).filter(Boolean))]),R=p(()=>[...new Set(a.value.map(e=>e.type))]),B=p(()=>{const e=new Date;return e.setHours(0,0,0,0),a.value.filter(t=>new Date(t.timestamp)>=e).length}),L=p(()=>{const e=new Date;return e.setDate(e.getDate()-7),e.setHours(0,0,0,0),a.value.filter(t=>new Date(t.timestamp)>=e).length}),P=p(()=>{const e={};return a.value.forEach(t=>{e[t.type]=(e[t.type]||0)+1}),e}),v=p(()=>{const t=at().filter;return a.value.filter(n=>!(t.search&&!n.title.toLowerCase().includes(t.search.toLowerCase())&&!n.message.toLowerCase().includes(t.search.toLowerCase())||t.module&&n.module!==t.module||t.type&&n.type!==t.type||t.read!==null&&n.read!==t.read||t.startDate&&new Date(n.timestamp)<t.startDate||t.endDate&&new Date(n.timestamp)>t.endDate))}),T=p(()=>y().config.groupByModule?v.value.reduce((t,n)=>{const r=n.module||"default";return t[r]||(t[r]=[]),t[r].push(n),t},{}):{default:v.value});async function k(e){try{i.value=!0,o.value=null;const t=await E(e),n=t.items,r=a.value,w=new Map;[...r,...n].forEach(f=>{w.set(f.id,f)}),a.value=Array.from(w.values()),s.value=t.total,l.value=Date.now()}catch(t){throw o.value=t instanceof Error?t.message:"获取通知失败",t}finally{i.value=!1}}async function _(e){try{await Z(e);const t=a.value.find(n=>n.id===e);t&&!t.read&&(t.read=!0)}catch(t){throw o.value=t instanceof Error?t.message:"标记已读失败",t}}async function $(){try{await tt(),a.value.forEach(e=>{e.read||(e.read=!0)})}catch(e){throw o.value=e instanceof Error?e.message:"标记全部已读失败",e}}async function F(e){try{await Y(e);const t=a.value.findIndex(n=>n.id===e);if(t>-1){const n=a.value[t];a.value.splice(t,1),s.value--}}catch(t){throw o.value=t instanceof Error?t.message:"删除通知失败",t}}async function O(){try{await et(),a.value=a.value.filter(e=>!e.read),s.value=a.value.length}catch(e){throw o.value=e instanceof Error?e.message:"清除已读通知失败",e}}function b(){const t=y().config.expirationDays,n=new Date;n.setDate(n.getDate()-t),a.value=a.value.filter(r=>new Date(r.timestamp)>n)}async function j(e){const t=y();await C.handleNewNotification(e),a.value.unshift(e),a.value.length>t.config.maxCount&&(a.value=a.value.slice(0,t.config.maxCount)),e.read||(c.value.soundEnabled&&await C.playSound(A[e.type]),c.value.desktopNotification&&await C.showDesktopNotification(e)),s.value++}function q(e){u.value=e}async function H(){Date.now()-l.value>5*60*1e3&&await k()}async function z(){var e,t,n,r,w,N;try{const f=await E({page:1,page_size:1,type:"system"});if(f.items.length>0){const g=f.items[0];c.value={maxCount:((e=g.data)==null?void 0:e.maxCount)??50,expirationDays:((t=g.data)==null?void 0:t.expirationDays)??7,soundEnabled:((n=g.data)==null?void 0:n.soundEnabled)??!0,desktopNotification:((r=g.data)==null?void 0:r.desktopNotification)??!0,groupByModule:((w=g.data)==null?void 0:w.groupByModule)??!0,autoCleanup:((N=g.data)==null?void 0:N.autoCleanup)??!0}}return c.value}catch(f){throw o.value=f instanceof Error?f.message:"获取设置失败",f}}async function I(e){try{return await x("settings",{type:"system",content:JSON.stringify(e),metadata:e}),c.value={...c.value,...e},c.value}catch(t){throw o.value=t instanceof Error?t.message:"更新设置失败",t}}async function J(e,t){try{await x(e,t);const n=a.value.find(r=>r.id===e);n&&Object.assign(n,t)}catch(n){throw o.value=n instanceof Error?n.message:"更新通知失败",n}}return{notifications:a,isLoading:i,error:o,total:s,wsConnected:u,lastSyncTime:l,settings:c,unreadCount:M,availableModules:Q,availableTypes:R,filteredNotifications:v,groupedNotifications:T,todayCount:B,weekCount:L,typeBreakdown:P,fetchNotifications:k,markAsRead:_,markAllAsRead:$,deleteNotification:F,clearAllNotifications:O,cleanupExpiredNotifications:b,handleNewNotification:j,setWebSocketConnected:q,syncNotifications:H,fetchSettings:z,updateSettings:I,updateNotificationSettings:J}});export{y as a,at as b,rt as f,ct as u};
