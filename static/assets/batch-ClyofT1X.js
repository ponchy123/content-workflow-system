import{h as O,p as f,aJ as j,l as re,t as l,N as w,H as _,C as J,ad as N,L as g,j as i,a as ne,i as k,y as v,aD as V,aE as G,x as t,A as ie,q as a,bb as Ce,F as Ae,B as Se,b7 as le,bc as de,G as Ee,bd as Te,r as h,be as Pe,bf as Me,aH as R,aI as u,bg as se,aM as qe,bh as Ve,bi as Le,aG as Fe,aF as Ie,P as Be,E as q,bj as X,bk as Ue,aL as $e}from"./vendor-BxNawP4f.js";import{u as Ne}from"./index-DyxCg8e9.js";import{_ as Y}from"./FormCard.vue_vue_type_script_setup_true_lang-C9NvR83c.js";import{_ as oe}from"./DataTable.vue_vue_type_script_setup_true_lang-H7XCXiZN.js";import{v as Ge,b as ze}from"./index-N1Xkh6eW.js";import{a as He}from"./index-DdmqVHKO.js";const K=O({__name:"StatusTag",props:{type:{default:"info"},text:{},icon:{},effect:{default:"light"},size:{default:"small"}},setup(T){return(m,P)=>{const b=J,p=j;return i(),f(p,{type:m.type,effect:m.effect,size:m.size,class:re(["status-tag",`status-tag--${m.type}`])},{default:l(()=>[m.icon?(i(),f(b,{key:0,class:"status-tag__icon"},{default:l(()=>[(i(),f(N(m.icon)))]),_:1})):w("",!0),_(" "+g(m.text),1)]),_:1},8,["type","effect","size","class"])}}});function Re(){const T=Ne(),m=p=>p?Array.isArray(p)?p.some(x=>T.permissions.includes(x)):T.permissions.includes(p):!0;return{checkPermission:m,hasAnyPermission:p=>p.some(x=>m(x)),hasAllPermissions:p=>p.every(x=>m(x))}}const Xe={class:"action-bar__primary"},Ye={class:"action-bar__secondary"},Q=O({__name:"ActionBar",props:{primaryActions:{default:()=>[]},secondaryActions:{default:()=>[]},moreActions:{default:()=>[]},vertical:{type:Boolean,default:!1},size:{default:"default"}},emits:["action"],setup(T,{emit:m}){const P=T,b=m,{checkPermission:p}=Re(),x=ne(()=>P.moreActions.some(c=>p(c.permission))),y=c=>({type:c.type||"default",size:P.size,disabled:c.disabled,loading:c.loading,...c.props}),L=c=>{c.handler?c.handler():b("action",c.key)},S=c=>{L(c)};return(c,M)=>{const C=J,A=ie,z=Ee,F=Ae,I=Se;return i(),k("div",{class:re(["action-bar",{"is-vertical":c.vertical}])},[v("div",Xe,[(i(!0),k(V,null,G(c.primaryActions,n=>(i(),k(V,{key:n.key},[a(p)(n.permission)?(i(),f(A,le({key:0,ref_for:!0},y(n),{onClick:H=>L(n)}),{default:l(()=>[n.icon?(i(),f(C,{key:0,class:"action-icon"},{default:l(()=>[(i(),f(N(n.icon)))]),_:2},1024)):w("",!0),_(" "+g(n.label),1)]),_:2},1040,["onClick"])):w("",!0)],64))),128))]),v("div",Ye,[(i(!0),k(V,null,G(c.secondaryActions,n=>(i(),k(V,{key:n.key},[a(p)(n.permission)?(i(),f(A,le({key:0,ref_for:!0},y(n),{onClick:H=>L(n)}),{default:l(()=>[n.icon?(i(),f(C,{key:0,class:"action-icon"},{default:l(()=>[(i(),f(N(n.icon)))]),_:2},1024)):w("",!0),_(" "+g(n.label),1)]),_:2},1040,["onClick"])):w("",!0)],64))),128)),c.moreActions.length&&x.value?(i(),f(I,{key:0,onCommand:S},{dropdown:l(()=>[t(F,null,{default:l(()=>[(i(!0),k(V,null,G(c.moreActions,n=>de((i(),f(z,{key:n.key,command:n,disabled:n.disabled},{default:l(()=>[n.icon?(i(),f(C,{key:0},{default:l(()=>[(i(),f(N(n.icon)))]),_:2},1024)):w("",!0),_(" "+g(n.label),1)]),_:2},1032,["command","disabled"])),[[Te,a(p)(n.permission)]])),128))]),_:1})]),default:l(()=>[t(A,null,{default:l(()=>[M[0]||(M[0]=_(" 更多操作 ")),t(C,{class:"el-icon--right"},{default:l(()=>[t(a(Ce))]),_:1})]),_:1})]),_:1})):w("",!0)])],2)}}}),Ke={class:"batch-calculator-view"},Qe={key:0,class:"validation-errors"},je={class:"template-preview-content"},Oe={class:"template-example mt-4"},Je={class:"template-actions mt-4"},We={class:"product-query-content"},Ze={class:"search-bar"},rt=O({__name:"batch",setup(T){const m=Be(),P=()=>{m.push("/calculator/history")},b=h(null),p=h([]),x=h([{prop:"status",label:"状态"},{prop:"fromAddress",label:"发件地址"},{prop:"toAddress",label:"收件地址"},{prop:"weight",label:"重量"},{prop:"quantity",label:"数量"},{prop:"productCode",label:"产品代码"},{prop:"orderDate",label:"订单时间"},{prop:"length",label:"长(CM)"},{prop:"width",label:"宽(CM)"},{prop:"height",label:"高(CM)"}]),y=h(null),L=h([{prop:"status",label:"状态"},{prop:"total_charge",label:"总费用"},{prop:"base_charge",label:"基础费用"},{prop:"fuel_surcharge",label:"燃油附加费"}]),S=h(!1),c=h(!1),M=h(!1),C=h(!1),A=h(""),z=h(!1),F=h([]),I=h([]),n=h([{code:"FDX-GRD",name:"FedEx Ground 标准服务",provider:"FedEx",serviceType:"地面服务",description:"提供经济实惠的地面运输服务，适合非急件",effectiveDate:"2024/1/1",expirationDate:"2024/12/31",status:!0},{code:"FDX-PRI",name:"FedEx Priority 优先服务",provider:"FedEx",serviceType:"空运服务",description:"提供最快的空运服务，次日达",effectiveDate:"2024/1/1",expirationDate:"2024/12/31",status:!0},{code:"UPS-STD",name:"UPS Standard 标准服务",provider:"UPS",serviceType:"地面服务",description:"提供可靠的地面运输服务",effectiveDate:"2024/1/1",expirationDate:"2024/12/31",status:!0},{code:"UPS-EXP",name:"UPS Express 快递服务",provider:"UPS",serviceType:"空运服务",description:"提供快速的国际和国内空运服务",effectiveDate:"2024/1/1",expirationDate:"2024/12/31",status:!0},{code:"DHL-INT",name:"DHL International 国际服务",provider:"DHL",serviceType:"国际快递",description:"专业的国际快递服务，全球覆盖",effectiveDate:"2024/1/1",expirationDate:"2024/12/31",status:!0}]),H=ne(()=>{if(!A.value)return n.value;const s=A.value.toLowerCase();return n.value.filter(e=>e.code.toLowerCase().includes(s)||e.name.toLowerCase().includes(s)||e.provider.toLowerCase().includes(s))}),W={pending:{type:"info",text:"待处理"},processing:{type:"warning",text:"处理中"},completed:{type:"success",text:"已完成"},failed:{type:"danger",text:"失败"}},Z={pending:{type:"warning",text:"等待处理"},processing:{type:"warning",text:"正在计算"},completed:{type:"success",text:"计算完成"},failed:{type:"danger",text:"计算失败"}},ee={success:{type:"success",text:"计算成功"},failed:{type:"danger",text:"计算失败"},invalid:{type:"warning",text:"数据无效"}},ce=s=>{var e;return((e=W[s])==null?void 0:e.type)||"info"},ue=s=>{var e;return((e=W[s])==null?void 0:e.text)||s},pe=s=>{var e;return((e=Z[s])==null?void 0:e.type)||"info"},fe=s=>{var e;return((e=Z[s])==null?void 0:e.text)||s},me=s=>{var e;return((e=ee[s])==null?void 0:e.type)||"info"},_e=s=>{var e;return((e=ee[s])==null?void 0:e.text)||s},he=async(s,e)=>{try{const d=await Ge(s.raw);b.value=d,d.isValid&&(p.value=d.data.map(r=>{var D,B,E,U,$,o;return{fromAddress:r.fromAddress,toAddress:r.toAddress,weight:r.weight,quantity:r.quantity,productCode:r.productCode,orderDate:r.orderDate,productType:r.productCode||"default",serviceLevel:"standard",length:r.length||((D=r.dimensions)==null?void 0:D.length)||0,width:r.width||((B=r.dimensions)==null?void 0:B.width)||0,height:r.height||((E=r.dimensions)==null?void 0:E.height)||0,volume:ye(r.length||((U=r.dimensions)==null?void 0:U.length)||0,r.width||(($=r.dimensions)==null?void 0:$.width)||0,r.height||((o=r.dimensions)==null?void 0:o.height)||0)}}))}catch{q.error("文件验证失败")}},ye=(s,e,d)=>!s||!e||!d?0:s*e*d/1e6,ve=s=>{const e=/\.(xlsx|xls)$/.test(s.name),d=s.size/1024/1024<10;return e?d?!0:(q.error("文件大小不能超过 10MB!"),!1):(q.error("只能上传 Excel 文件!"),!1)},ge=async()=>{var s,e;if((s=b.value)!=null&&s.isValid){S.value=!0;try{const d=await ze({items:p.value}),r=new Date().toISOString();y.value={task_id:d.taskId,file_name:d.filename||"batch_calculation.xlsx",status:d.state,total_records:d.total||0,processed_records:d.processed||0,success_records:d.success||0,failed_records:d.failed||0,calculation_results:((e=d.items)==null?void 0:e.map(D=>({status:D.status,total_charge:D.totalCharge||0,base_charge:D.baseCharge||0,fuel_surcharge:D.fuelSurcharge||0})))||[],created_at:r,updated_at:r}}catch{q.error("计算失败")}finally{S.value=!1}}},be=()=>{var s;c.value=!0;try{(s=y.value)!=null&&s.task_id&&console.log("导出任务:",y.value.task_id)}finally{c.value=!1}},we=()=>{F.value=[{field:"fromAddress",name:"发件地址",required:!0,description:"发货地邮编，例如：100000",example:"100000"},{field:"toAddress",name:"收件地址",required:!0,description:"收货地邮编，例如：200000",example:"200000"},{field:"weight",name:"重量",required:!0,description:"货物重量，单位可为KG/LB/OZ",example:"10"},{field:"quantity",name:"数量",required:!0,description:"包裹数量",example:"1"},{field:"productCode",name:"产品代码",required:!0,description:"产品或报价单代码，用于确定计费标准",example:"FDX-GRD"},{field:"orderDate",name:"订单时间",required:!0,description:"订单创建时间，用于判断旺季附加费，格式：YYYY/M/D",example:"2024/4/1"},{field:"length",name:"长",required:!0,description:"包裹长度，单位可为CM/IN",example:"30"},{field:"width",name:"宽",required:!0,description:"包裹宽度，单位可为CM/IN",example:"20"},{field:"height",name:"高",required:!0,description:"包裹高度，单位可为CM/IN",example:"10"}],I.value=[{fromAddress:"100000",toAddress:"200000",weight:10,quantity:1,productCode:"FDX-GRD",orderDate:"2024/4/1",length:30,width:20,height:10},{fromAddress:"100000",toAddress:"300000",weight:5,quantity:2,productCode:"UPS-STD",orderDate:"2024/4/2",length:25,width:15,height:10},{fromAddress:"200000",toAddress:"400000",weight:15,quantity:1,productCode:"DHL-INT",orderDate:"2024/4/3",length:40,width:30,height:20}],M.value=!0},xe=()=>{try{const s=[["发件地址","收件地址","重量(KG)","数量","产品代码","订单时间","长(CM)","宽(CM)","高(CM)"],["北京市","上海市",10,100,"FDX-GRD","2024/4/1",100,50,50],["北京市","广州市",10,100,"UPS-STD","2024/4/2",100,50,50],["北京市","深圳市",10,100,"DHL-INT","2024/4/3",100,50,50]],e=X.aoa_to_sheet(s),d=[{wch:15},{wch:15},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10}];e["!cols"]=d;const r=X.book_new();X.book_append_sheet(r,e,"批量计算模板"),Ue(r,"批量计算模板.xlsx"),q.success("模板导出成功")}catch(s){console.error("导出模板失败:",s),q.error("导出模板失败")}},De=()=>{C.value=!0},te=s=>{const e=new Date(s);return`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`};return(s,e)=>{const d=J,r=$e,D=ie,B=qe,E=Fe,U=Ie,$=Le;return i(),k("div",Ke,[t(a(Y),{title:"批量运费计算"},{actions:l(()=>[t(a(Q),{"primary-actions":[{key:"history",label:"计算历史",type:"info",icon:"Clock",handler:P},{key:"productQuery",label:"产品查询",type:"warning",icon:"Search",handler:De},{key:"template",label:"模板预览",type:"primary",icon:"View",handler:we}]},null,8,["primary-actions"])]),default:l(()=>{var o;return[t(a(Pe),{class:"upload-area",drag:"",accept:".xlsx,.xls",limit:1,"auto-upload":!1,"on-change":he,"show-file-list":!1,"before-upload":ve},{tip:l(()=>e[3]||(e[3]=[v("div",{class:"el-upload__tip"},"只能上传 xlsx/xls 文件，且文件大小不超过 10MB",-1)])),default:l(()=>[t(d,{class:"el-icon--upload"},{default:l(()=>[t(a(Me))]),_:1}),e[4]||(e[4]=v("div",{class:"el-upload__text"},[_("将文件拖到此处，或"),v("em",null,"点击上传")],-1))]),_:1}),(o=b.value)!=null&&o.errors?(i(),k("div",Qe,[(i(!0),k(V,null,G(b.value.errors,(ae,ke)=>(i(),f(r,{key:ke,title:ae.message,type:ae.type||"error","show-icon":"",closable:!1},null,8,["title","type"]))),128))])):w("",!0)]}),_:1}),t(a(se),{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=o=>M.value=o),title:"批量计算模板预览",width:"80%","close-on-click-modal":!1,"destroy-on-close":""},{default:l(()=>[v("div",je,[e[7]||(e[7]=v("p",{class:"template-description"}," 批量计算模板包含以下字段，请按照要求填写数据后上传： ",-1)),t(a(R),{data:F.value,border:"",style:{width:"100%"},"header-cell-style":{background:"#f5f7fa"}},{default:l(()=>[t(a(u),{prop:"field",label:"字段名",width:"150"}),t(a(u),{prop:"name",label:"中文名称",width:"150"}),t(a(u),{prop:"required",label:"是否必填",width:"100"},{default:l(({row:o})=>[t(a(j),{type:o.required?"danger":"info"},{default:l(()=>[_(g(o.required?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),t(a(u),{prop:"description",label:"说明"}),t(a(u),{prop:"example",label:"示例",width:"150"})]),_:1},8,["data"]),v("div",Oe,[e[5]||(e[5]=v("h4",null,"填写实例：",-1)),t(a(R),{data:I.value,border:"",style:{width:"100%"},"header-cell-style":{background:"#f5f7fa"}},{default:l(()=>[t(a(u),{prop:"fromAddress",label:"发件地址"}),t(a(u),{prop:"toAddress",label:"收件地址"}),t(a(u),{prop:"weight",label:"重量(KG)"}),t(a(u),{prop:"quantity",label:"数量"}),t(a(u),{prop:"productCode",label:"产品代码"}),t(a(u),{prop:"orderDate",label:"订单时间"}),t(a(u),{prop:"length",label:"长(CM)"}),t(a(u),{prop:"width",label:"宽(CM)"}),t(a(u),{prop:"height",label:"高(CM)"})]),_:1},8,["data"])]),v("div",Je,[t(D,{type:"primary",onClick:xe},{default:l(()=>e[6]||(e[6]=[_("导出Excel模板")])),_:1})])])]),_:1},8,["modelValue"]),t(a(se),{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=o=>C.value=o),title:"产品代码查询",width:"80%","close-on-click-modal":!1,"destroy-on-close":""},{default:l(()=>[v("div",We,[v("div",Ze,[t(B,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=o=>A.value=o),placeholder:"输入产品名称或代码搜索",class:"search-input",clearable:""},{prefix:l(()=>[t(d,null,{default:l(()=>[t(a(Ve))]),_:1})]),_:1},8,["modelValue"])]),de((i(),f(a(R),{data:H.value,border:"",stripe:"",style:{width:"100%"},"header-cell-style":{background:"#f5f7fa"}},{default:l(()=>[t(a(u),{prop:"code",label:"产品代码",width:"150"}),t(a(u),{prop:"name",label:"产品名称",width:"200"}),t(a(u),{prop:"provider",label:"服务商",width:"150"}),t(a(u),{prop:"serviceType",label:"服务类型",width:"150"}),t(a(u),{prop:"description",label:"描述"}),t(a(u),{prop:"effectiveDate",label:"生效日期",width:"120"},{default:l(({row:o})=>[_(g(te(o.effectiveDate)),1)]),_:1}),t(a(u),{prop:"expirationDate",label:"失效日期",width:"120"},{default:l(({row:o})=>[_(g(te(o.expirationDate)),1)]),_:1}),t(a(u),{label:"状态",width:"100"},{default:l(({row:o})=>[t(a(j),{type:o.status?"success":"danger"},{default:l(()=>[_(g(o.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[$,z.value]])])]),_:1},8,["modelValue"]),p.value.length?(i(),f(a(Y),{key:0,title:"数据预览",class:"preview-card"},{actions:l(()=>{var o;return[t(a(Q),{"primary-actions":[{key:"calculate",label:"开始计算",type:"primary",loading:S.value,disabled:S.value||!((o=b.value)!=null&&o.isValid),handler:ge}]},null,8,["primary-actions"])]}),default:l(()=>[t(a(oe),{data:p.value,columns:x.value,loading:S.value},{"column-status":l(({value:o})=>[t(a(K),{type:ce(o),text:ue(o)},null,8,["type","text"])]),_:1},8,["data","columns","loading"])]),_:1})):w("",!0),y.value?(i(),f(a(Y),{key:1,title:"计算结果",class:"result-card"},{actions:l(()=>[t(a(Q),{"primary-actions":[{key:"export",label:"导出结果",type:"primary",icon:"Download",handler:be}]},null,8,["primary-actions"])]),default:l(()=>[t(U,{column:2,border:""},{default:l(()=>[t(E,{label:"任务状态"},{default:l(()=>[t(a(K),{type:pe(y.value.status),text:fe(y.value.status)},null,8,["type","text"])]),_:1}),t(E,{label:"总记录数"},{default:l(()=>[_(g(y.value.total_records),1)]),_:1}),t(E,{label:"成功记录"},{default:l(()=>[_(g(y.value.success_records),1)]),_:1}),t(E,{label:"失败记录"},{default:l(()=>[_(g(y.value.failed_records),1)]),_:1})]),_:1}),t(a(oe),{data:y.value.calculation_results,columns:L.value,loading:c.value},{"column-status":l(({value:o})=>[t(a(K),{type:me(o),text:_e(o)},null,8,["type","text"])]),"column-total_charge":l(({value:o})=>[_(g(a(He)(o)),1)]),_:1},8,["data","columns","loading"])]),_:1})):w("",!0)])}}});export{rt as default};
