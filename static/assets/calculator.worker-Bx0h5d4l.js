(function(){"use strict";function u(a){const{weight:s,volume:e,quantity:t,productType:o,serviceLevel:n}=a;let r=s*10;if(e){const c=e/5e3;r=Math.max(r,c*10)}switch(o){case"express":r*=1.5;break;case"standard":r*=1;break;case"economy":r*=.8;break}switch(n){case"premium":r*=1.3;break;case"basic":r*=1;break}return r*=t,parseFloat(r.toFixed(2))}function d(a,s){let e=a;const t=[];return a>500&&(e=a*.95,t.push("大额订单折扣：订单金额超过500元，享受95折优惠")),s.serviceLevel==="premium"&&s.quantity>5&&(e=e*.9,t.push("批量高级服务折扣：高级服务且数量大于5，享受额外90折优惠")),s.isDangerous&&(e=e*1.5,t.push("危险品附加费：危险品运输需支付50%额外费用")),{finalRate:parseFloat(e.toFixed(2)),appliedRules:t}}const i=self;i.addEventListener("message",a=>{var s;try{const{type:e,payload:t,id:o}=a.data;switch(e){case"calculate":p(t,o);break;case"batch_calculate":g(t,o);break;default:i.postMessage({error:`未知的操作类型: ${e}`,id:o})}}catch(e){i.postMessage({error:e instanceof Error?e.message:"计算过程发生未知错误",id:(s=a.data)==null?void 0:s.id})}});async function p(a,s){try{const e=u(a),t=parseFloat((e*.1).toFixed(2)),o=a.insuranceValue?parseFloat((a.insuranceValue*.01).toFixed(2)):0,{finalRate:n,appliedRules:r}=d(e,a),c={weightCharge:parseFloat((a.weight*10).toFixed(2)),distanceCharge:30,zoneCharge:50,volumeCharge:a.volume?parseFloat((a.volume/5e3*10).toFixed(2)):void 0,additionalCharges:[]};a.isDangerous&&c.additionalCharges.push({name:"危险品处理费",amount:parseFloat((e*.5).toFixed(2)),type:"dangerous",description:"危险品特殊处理费用"});const l={requestId:s,baseCharge:e,fuelSurcharge:t,insuranceFee:o,totalCharge:parseFloat(n.toFixed(2)),currency:"CNY",estimatedDays:3,details:c,status:"success"};i.postMessage({result:l,id:s})}catch(e){i.postMessage({error:e instanceof Error?e.message:"计算过程发生未知错误",id:s})}}async function g(a,s){try{const e=[];for(let t=0;t<a.length;t++){const o=a[t],n=u(o),r=parseFloat((n*.1).toFixed(2)),c=o.insuranceValue?parseFloat((o.insuranceValue*.01).toFixed(2)):0,{finalRate:l,appliedRules:F}=d(n,o),h=`${s}-${t}`;e.push({requestId:h,baseCharge:n,fuelSurcharge:r,insuranceFee:c,totalCharge:parseFloat(l.toFixed(2)),currency:"CNY",estimatedDays:3,details:{weightCharge:parseFloat((o.weight*10).toFixed(2)),distanceCharge:30,zoneCharge:50,volumeCharge:o.volume?parseFloat((o.volume/5e3*10).toFixed(2)):void 0,additionalCharges:[]},status:"success"}),((t+1)%10===0||t===a.length-1)&&i.postMessage({progress:{current:t+1,total:a.length},id:s})}i.postMessage({batchResults:e,id:s})}catch(e){i.postMessage({error:e instanceof Error?e.message:"批量计算过程发生未知错误",id:s})}}i.postMessage({type:"ready"})})();
