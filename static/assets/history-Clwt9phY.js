import{d as g,r as u,bv as _,bj as a,bk as d,E as n}from"./vendor-BxNawP4f.js";import{g as h,d as w}from"./index-DyxCg8e9.js";async function x(e=1,s=10){return h("/api/calculator/history",{params:{page:e,pageSize:s}})}async function m(e){return h(`/api/calculator/history/${e}`)}async function H(){return w("/api/calculator/history")}async function b(e,s){return h("/api/calculator/history/export",{params:{startDate:e.toISOString().split("T")[0],endDate:s.toISOString().split("T")[0]},responseType:"blob"})}const C=g("history",()=>{const e=u(!1),s=u([]),l=u(null),y=u({page:1,pageSize:10,total:0});return{loading:e,histories:s,currentDetail:l,pagination:y,fetchHistories:async(r=1,t=10)=>{e.value=!0;try{const o=await x(r,t);return s.value=o.items,y.value={page:r,pageSize:t,total:o.total},!0}catch(o){return console.error("Failed to fetch histories:",o),!1}finally{e.value=!1}},fetchHistoryDetail:async r=>{e.value=!0;try{const t=await m(r);return l.value=t,!0}catch(t){return console.error("Failed to fetch history detail:",t),!1}finally{e.value=!1}},clearCurrentDetail:()=>{l.value=null},exportHistory:async(r,t)=>{e.value=!0;try{const o=await b(r,t),i=_(o,{type:"array"}),c=i.Sheets[i.SheetNames[0]],p=a.sheet_to_json(c),S=a.json_to_sheet(p),f=a.book_new();a.book_append_sheet(f,S,"计算历史");const v=`运费计算历史_${r.toISOString().split("T")[0]}_${t.toISOString().split("T")[0]}.xlsx`;d(f,v),n.success("导出成功")}catch(o){console.error("Failed to export history:",o),n.error("导出失败")}finally{e.value=!1}},exportDetail:async r=>{if(l.value)try{const t=l.value,o=[{计算时间:new Date(t.timestamp).toLocaleString(),用户:t.user.username,基础运费:t.baseCharge,燃油附加费:t.fuelSurcharge,保险费:t.insuranceFee,总费用:t.totalCharge,预计天数:t.estimatedDays,币种:t.currency,状态:t.status||"成功"}],i=a.json_to_sheet(o),c=a.book_new();a.book_append_sheet(c,i,"计算详情");const p=`运费计算详情_${r}_${new Date().toISOString().split("T")[0]}.xlsx`;d(c,p),n.success("导出成功")}catch(t){console.error("Export detail failed:",t),n.error("导出失败")}},clearHistory:async()=>{e.value=!0;try{await H(),s.value=[],y.value.total=0,n.success("历史记录已清空")}catch(r){console.error("Failed to clear history:",r),n.error("清空失败")}finally{e.value=!1}}}});export{C as u};
