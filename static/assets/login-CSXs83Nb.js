import{h as N,r as _,i as R,x as a,t,aN as U,aO as L,y as d,aP as T,aM as q,q as y,a7 as A,a8 as B,aQ as M,H as m,aR as O,A as J,L as K,au as Q,E as u,P as j,Q as D,j as H}from"./vendor-BxNawP4f.js";import{u as $}from"./useAuth-DsFeK4Ey.js";import{u as z,s as S,_ as G}from"./index-DyxCg8e9.js";const W={class:"login-container"},X={class:"form-options"},Y={class:"register-link"},Z=N({__name:"login",setup(ee){const k=_(),l=_({username:"",password:""}),n=_(!1),v=_(!1),w=j(),{login:x}=$(),I=z(),V=D(),E={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:20,message:"密码长度应在6-20个字符之间",trigger:"blur"}]},b=async()=>{var g,e,o;if(k.value)try{n.value=!0,await k.value.validate();const s=await x(l.value.username,l.value.password);if(console.log("登录API调用成功:",s),!s)throw new Error("登录失败：未知错误");v.value?S.set("remembered_username",l.value.username):S.remove("remembered_username"),I.$patch({token:localStorage.getItem("access_token"),userInfo:JSON.parse(localStorage.getItem("user_info")||"{}")}),F()}catch(s){console.error("Login failed:",s),((g=s.response)==null?void 0:g.status)===401?u.error("用户名或密码错误"):(o=(e=s.response)==null?void 0:e.data)!=null&&o.detail?u.error(s.response.data.detail):u.error(s.message||"登录失败，请稍后重试")}finally{n.value=!1}},P=()=>{w.push("/auth/register")},C=()=>{w.push("/auth/forgot-password")},F=()=>{var p;if(u.success("登录成功"),!localStorage.getItem("token")){console.warn("未检测到token，尝试复制token到access_token键");const r=localStorage.getItem("token");if(r)localStorage.setItem("access_token",r),console.log("已将token复制到access_token键");else{console.error("找不到有效的token"),u.error("登录异常：无法获取认证令牌");return}}const e=localStorage.getItem("user_info");let o;try{o=e?JSON.parse(e):null}catch(r){console.error("解析用户信息失败:",r),o=null}const s=(p=o==null?void 0:o.roles)==null?void 0:p.includes("admin"),i=V.query.redirect||(s?"/admin/dashboard":"/dashboard");console.log("登录成功，用户信息:",o),console.log("用户角色:",o==null?void 0:o.roles,"是否管理员:",s),console.log("将跳转到:",i),console.log("认证信息检查:"),console.log("- token:",localStorage.getItem("token")),console.log("- access_token:",localStorage.getItem("access_token")),console.log("- user_info:",localStorage.getItem("user_info")),n.value=!0,setTimeout(()=>{try{const f=window.location.origin+i;console.log("正在跳转到:",f),window.location.href=f}catch(r){console.error("导航过程出错:",r),n.value=!1,u.error("跳转失败，请重试")}},500)};return(g,e)=>{const o=q,s=T,h=M,i=O,p=J,r=U,f=Q;return H(),R("div",W,[a(f,{class:"login-card"},{header:t(()=>e[3]||(e[3]=[d("div",{class:"card-header"},[d("h2",{class:"header-title"},"欢迎回来"),d("p",{class:"header-subtitle"},"请登录您的账号")],-1)])),default:t(()=>[a(r,{ref_key:"loginFormRef",ref:k,model:l.value,rules:E,"label-position":"top",onKeyup:L(b,["enter"])},{default:t(()=>[a(s,{label:"用户名",prop:"username"},{default:t(()=>[a(o,{modelValue:l.value.username,"onUpdate:modelValue":e[0]||(e[0]=c=>l.value.username=c),placeholder:"请输入用户名","prefix-icon":y(A)},null,8,["modelValue","prefix-icon"])]),_:1}),a(s,{label:"密码",prop:"password"},{default:t(()=>[a(o,{modelValue:l.value.password,"onUpdate:modelValue":e[1]||(e[1]=c=>l.value.password=c),type:"password",placeholder:"请输入密码","prefix-icon":y(B),"show-password":""},null,8,["modelValue","prefix-icon"])]),_:1}),d("div",X,[a(h,{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=c=>v.value=c)},{default:t(()=>e[4]||(e[4]=[m("记住我")])),_:1},8,["modelValue"]),a(i,{type:"primary",underline:!1,onClick:C},{default:t(()=>e[5]||(e[5]=[m("忘记密码？")])),_:1})]),a(s,null,{default:t(()=>[a(p,{type:"primary",loading:n.value,class:"login-button",onClick:b},{default:t(()=>[m(K(n.value?"登录中...":"登录"),1)]),_:1},8,["loading"])]),_:1}),d("div",Y,[e[7]||(e[7]=m(" 还没有账号？ ")),a(i,{type:"primary",onClick:P},{default:t(()=>e[6]||(e[6]=[m("立即注册")])),_:1})])]),_:1},8,["model"])]),_:1})])}}}),te=G(Z,[["__scopeId","data-v-0b4cc85e"]]);export{te as default};
