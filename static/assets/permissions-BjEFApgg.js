import{h as ge,r as m,w as Be,aq as X,a as Y,o as be,i as R,x as a,t as r,y as c,A as he,H as i,C as Ie,q as _,bw as K,aY as we,au as Ve,aM as ke,aA as Te,aB as Ee,p as S,N as T,bW as Ce,L as f,aW as xe,b9 as $,bE as Q,bp as Se,aF as Pe,aG as Ne,aJ as De,aH as Me,aI as Re,aN as $e,bX as Fe,aP as Oe,ba as Ue,aV as ze,bg as qe,n as Z,E as y,j as h,ae as Ae}from"./vendor-BxNawP4f.js";import{f as F}from"./index-DdmqVHKO.js";import{_ as Je}from"./index-DyxCg8e9.js";const Le={class:"page-container"},Ge={class:"page-header"},He={class:"flex gap-base"},We={class:"flex items-center mb-base"},je={class:"main-content"},Xe={class:"custom-tree-node"},Ye={class:"node-label"},Ke={key:0,class:"node-code"},Qe={class:"node-actions"},Ze={class:"card-header"},et={key:0,class:"roles-section"},tt={class:"dialog-footer"},at=ge({__name:"permissions",setup(ot){const I=m(!1),p=m([]),O=m(),P=m(""),s=m({}),N=m([]),E=m("tree"),ee=(e,t)=>e?t.name.includes(e)||t.code&&t.code.includes(e):!0;Be(P,e=>{var t;(t=O.value)==null||t.filter(e)});const U=async()=>{I.value=!0;try{await new Promise(e=>setTimeout(e,500)),p.value=ce(),p.value.length>0&&Z(()=>{z(p.value[0])})}catch(e){console.error("获取权限列表失败:",e),y.error("获取权限列表失败")}finally{I.value=!1}},te=()=>{U()},z=e=>{s.value=e,ae(e.id)},ae=async e=>{try{await new Promise(l=>setTimeout(l,500));const t=Array.from({length:Math.floor(Math.random()*5)+1},(l,d)=>{const u=new Date;u.setTime(u.getTime()-Math.random()*90*24*3600*1e3);const v=[{name:"超级管理员",code:"admin"},{name:"系统管理员",code:"system"},{name:"数据分析员",code:"analyst"},{name:"运营人员",code:"operator"},{name:"普通用户",code:"user"}],g=v[d%v.length];return{id:`role-${d+1}`,name:g.name,code:g.code,description:`${g.name}的权限描述`,status:Math.random()>.2,created_at:u.toISOString(),updated_at:u.toISOString()}});N.value=t}catch(t){console.error("获取权限角色失败:",t),y.error("获取权限角色失败")}},B=m(!1),b=m("add"),C=m(),o=X({id:"",parentId:"",name:"",code:"",isButton:!1,description:"",sort:0}),oe=X({name:[{required:!0,message:"请输入权限名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],code:[{required:!0,message:"请输入权限标识",trigger:"blur"},{pattern:/^[a-z][a-z0-9:]*$/,message:"权限标识只能包含小写字母、数字和冒号，且以字母开头",trigger:"blur"}],sort:[{required:!0,message:"请输入排序值",trigger:"blur"}]}),re=Y(()=>{switch(b.value){case"add":return"新增权限";case"edit":return"编辑权限";case"addChild":return`新增 ${o.parentId?de(o.parentId):""} 的子权限`;default:return""}}),de=e=>{const t=l=>{for(const d of l){if(d.id===e)return d.name;if(d.children&&d.children.length>0){const u=t(d.children);if(u)return u}}return""};return t(p.value)},le=Y(()=>JSON.parse(JSON.stringify(p.value))),ne=()=>{b.value="add",D(),B.value=!0},se=e=>{if(b.value="addChild",D(),o.parentId=e.id,e.isButton){y.warning("按钮权限下不能添加子权限");return}e.code&&(o.code=`${e.code}:`),B.value=!0},q=e=>{b.value="edit",D(),o.id=e.id,o.parentId=e.parentId||"",o.name=e.name,o.code=e.code,o.isButton=e.isButton,o.description=e.description||"",o.sort=e.sort,B.value=!0},D=()=>{o.id="",o.parentId="",o.name="",o.code="",o.isButton=!1,o.description="",o.sort=0,Z(()=>{var e;(e=C.value)==null||e.resetFields()})},ie=async()=>{C.value&&await C.value.validate(async e=>{if(e)try{if(I.value=!0,await new Promise(t=>setTimeout(t,500)),b.value==="edit")A(p.value,{id:o.id,name:o.name,code:o.code,parentId:o.parentId,isButton:o.isButton,description:o.description,sort:o.sort,created_at:s.value.created_at,updated_at:new Date().toISOString()}),y.success("编辑权限成功"),s.value.id===o.id&&(s.value={...s.value,name:o.name,isButton:o.isButton,description:o.description,sort:o.sort,updated_at:new Date().toISOString()});else{const t={id:`permission-${new Date().getTime()}`,name:o.name,code:o.code,parentId:o.parentId||void 0,isButton:o.isButton,description:o.description,sort:o.sort,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};o.parentId?J(p.value,o.parentId,t):(p.value.push(t),p.value.sort((l,d)=>l.sort-d.sort)),y.success("新增权限成功")}B.value=!1}catch(t){console.error("提交权限表单失败:",t),y.error("操作失败，请重试")}finally{I.value=!1}})},A=(e,t)=>{for(let l=0;l<e.length;l++){if(e[l].id===t.id)return e[l]={...e[l],...t},!0;const d=e[l].children||[];if(d.length>0&&A(d,t))return!0}return!1},J=(e,t,l)=>{for(let d=0;d<e.length;d++){if(e[d].id===t)return e[d].children||(e[d].children=[]),e[d].children.push(l),e[d].children.sort((v,g)=>v.sort-g.sort),!0;const u=e[d].children||[];if(u.length>0&&J(u,t,l))return!0}return!1},ue=e=>{if(e.children&&e.children.length>0){y.warning("该权限下有子权限，无法删除");return}Ae.confirm("确定要删除该权限吗？删除后将无法恢复，并可能影响已分配该权限的角色。","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{I.value=!0,await new Promise(t=>setTimeout(t,500)),L(p.value,e.id),s.value.id===e.id&&(s.value={},N.value=[]),y.success("删除权限成功")}catch(t){console.error("删除权限失败:",t),y.error("删除权限失败")}finally{I.value=!1}}).catch(()=>{})},L=(e,t)=>{for(let l=0;l<e.length;l++){if(e[l].id===t)return e.splice(l,1),!0;const d=e[l].children||[];if(d.length>0&&L(d,t))return!0}return!1},ce=()=>{const e=new Date().toISOString();return[{id:"system",name:"系统管理",code:"system",isButton:!1,sort:1,created_at:e,updated_at:e,children:[{id:"user",name:"用户管理",code:"system:user",parentId:"system",isButton:!1,sort:1,created_at:e,updated_at:e,children:[{id:"user:view",name:"查看用户",code:"system:user:view",parentId:"user",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"user:create",name:"创建用户",code:"system:user:create",parentId:"user",isButton:!0,sort:2,created_at:e,updated_at:e},{id:"user:edit",name:"编辑用户",code:"system:user:edit",parentId:"user",isButton:!0,sort:3,created_at:e,updated_at:e},{id:"user:delete",name:"删除用户",code:"system:user:delete",parentId:"user",isButton:!0,sort:4,created_at:e,updated_at:e}]},{id:"role",name:"角色管理",code:"system:role",parentId:"system",isButton:!1,sort:2,created_at:e,updated_at:e,children:[{id:"role:view",name:"查看角色",code:"system:role:view",parentId:"role",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"role:create",name:"创建角色",code:"system:role:create",parentId:"role",isButton:!0,sort:2,created_at:e,updated_at:e},{id:"role:edit",name:"编辑角色",code:"system:role:edit",parentId:"role",isButton:!0,sort:3,created_at:e,updated_at:e},{id:"role:delete",name:"删除角色",code:"system:role:delete",parentId:"role",isButton:!0,sort:4,created_at:e,updated_at:e}]},{id:"permission",name:"权限管理",code:"system:permission",parentId:"system",isButton:!1,sort:3,created_at:e,updated_at:e,children:[{id:"permission:view",name:"查看权限",code:"system:permission:view",parentId:"permission",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"permission:create",name:"创建权限",code:"system:permission:create",parentId:"permission",isButton:!0,sort:2,created_at:e,updated_at:e},{id:"permission:edit",name:"编辑权限",code:"system:permission:edit",parentId:"permission",isButton:!0,sort:3,created_at:e,updated_at:e},{id:"permission:delete",name:"删除权限",code:"system:permission:delete",parentId:"permission",isButton:!0,sort:4,created_at:e,updated_at:e}]},{id:"log",name:"日志管理",code:"system:log",parentId:"system",isButton:!1,sort:4,created_at:e,updated_at:e,children:[{id:"log:view",name:"查看日志",code:"system:log:view",parentId:"log",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"log:delete",name:"删除日志",code:"system:log:delete",parentId:"log",isButton:!0,sort:2,created_at:e,updated_at:e}]}]},{id:"product",name:"产品管理",code:"product",isButton:!1,sort:2,created_at:e,updated_at:e,children:[{id:"product:view",name:"查看产品",code:"product:view",parentId:"product",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"product:create",name:"创建产品",code:"product:create",parentId:"product",isButton:!0,sort:2,created_at:e,updated_at:e},{id:"product:edit",name:"编辑产品",code:"product:edit",parentId:"product",isButton:!0,sort:3,created_at:e,updated_at:e},{id:"product:delete",name:"删除产品",code:"product:delete",parentId:"product",isButton:!0,sort:4,created_at:e,updated_at:e}]},{id:"fuel-rate",name:"燃油费率管理",code:"fuel-rate",isButton:!1,sort:3,created_at:e,updated_at:e,children:[{id:"fuel-rate:view",name:"查看费率",code:"fuel-rate:view",parentId:"fuel-rate",isButton:!0,sort:1,created_at:e,updated_at:e},{id:"fuel-rate:create",name:"创建费率",code:"fuel-rate:create",parentId:"fuel-rate",isButton:!0,sort:2,created_at:e,updated_at:e},{id:"fuel-rate:edit",name:"编辑费率",code:"fuel-rate:edit",parentId:"fuel-rate",isButton:!0,sort:3,created_at:e,updated_at:e},{id:"fuel-rate:delete",name:"删除费率",code:"fuel-rate:delete",parentId:"fuel-rate",isButton:!0,sort:4,created_at:e,updated_at:e},{id:"fuel-rate:trend",name:"查看趋势",code:"fuel-rate:trend",parentId:"fuel-rate",isButton:!0,sort:5,created_at:e,updated_at:e}]}]};return be(()=>{U()}),(e,t)=>{const l=Ie,d=he,u=Ve,v=ke,g=Ee,G=Te,M=xe,w=Ne,H=De,pe=Pe,x=Re,me=Me,_e=Fe,V=Oe,W=Ue,fe=ze,ve=$e,ye=qe;return h(),R("div",Le,[a(u,{class:"mb-base"},{default:r(()=>[c("div",Ge,[t[13]||(t[13]=c("h1",{class:"page-title"},"权限管理",-1)),c("div",He,[a(d,{type:"primary",onClick:ne},{default:r(()=>[a(l,null,{default:r(()=>[a(_(K))]),_:1}),t[11]||(t[11]=i("新增权限 "))]),_:1}),a(d,{onClick:te},{default:r(()=>[a(l,null,{default:r(()=>[a(_(we))]),_:1}),t[12]||(t[12]=i("刷新 "))]),_:1})])])]),_:1}),a(u,null,{default:r(()=>[c("div",We,[a(v,{modelValue:P.value,"onUpdate:modelValue":t[0]||(t[0]=n=>P.value=n),placeholder:"输入关键字进行过滤",class:"mr-base",style:{width:"300px"},clearable:""},null,8,["modelValue"]),a(G,{modelValue:E.value,"onUpdate:modelValue":t[1]||(t[1]=n=>E.value=n),class:"ml-auto"},{default:r(()=>[a(g,{value:"tree"},{default:r(()=>t[14]||(t[14]=[i("树形结构")])),_:1}),a(g,{value:"list"},{default:r(()=>t[15]||(t[15]=[i("列表结构")])),_:1})]),_:1},8,["modelValue"])]),c("div",je,[E.value==="tree"?(h(),S(u,{key:0,class:"tree-card"},{header:r(()=>t[16]||(t[16]=[c("div",{class:"card-header"},[c("span",null,"权限结构树")],-1)])),default:r(()=>[a(_(Ce),{ref_key:"permissionTreeRef",ref:O,data:p.value,"node-key":"id","highlight-current":"","expand-on-click-node":!1,props:{label:"name",children:"children"},"filter-node-method":ee,onNodeClick:z},{default:r(({node:n,data:k})=>[c("div",Xe,[c("span",Ye,f(n.label),1),k.code?(h(),R("span",Ke,f(k.code),1)):T("",!0),c("div",Qe,[k.isButton?T("",!0):(h(),S(M,{key:0,content:"添加子权限",placement:"top"},{default:r(()=>[a(d,{type:"primary",circle:"",size:"small",onClick:$(j=>se(k),["stop"])},{default:r(()=>[a(l,null,{default:r(()=>[a(_(K))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)),a(M,{content:"编辑权限",placement:"top"},{default:r(()=>[a(d,{type:"warning",circle:"",size:"small",onClick:$(j=>q(k),["stop"])},{default:r(()=>[a(l,null,{default:r(()=>[a(_(Q))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024),a(M,{content:"删除权限",placement:"top"},{default:r(()=>[a(d,{type:"danger",circle:"",size:"small",onClick:$(j=>ue(k),["stop"])},{default:r(()=>[a(l,null,{default:r(()=>[a(_(Se))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)])])]),_:1},8,["data"])]),_:1})):T("",!0),s.value.id&&E.value==="list"?(h(),S(u,{key:1,class:"detail-card"},{header:r(()=>[c("div",Ze,[t[18]||(t[18]=c("span",null,"权限详情",-1)),a(d,{type:"primary",link:"",onClick:t[2]||(t[2]=n=>q(s.value))},{default:r(()=>[a(l,null,{default:r(()=>[a(_(Q))]),_:1}),t[17]||(t[17]=i("编辑 "))]),_:1})])]),default:r(()=>[a(pe,{column:1,border:""},{default:r(()=>[a(w,{label:"权限名称"},{default:r(()=>[i(f(s.value.name),1)]),_:1}),a(w,{label:"权限标识"},{default:r(()=>[i(f(s.value.code),1)]),_:1}),a(w,{label:"权限类型"},{default:r(()=>[a(H,{type:s.value.isButton?"danger":"primary"},{default:r(()=>[i(f(s.value.isButton?"按钮权限":"菜单权限"),1)]),_:1},8,["type"])]),_:1}),a(w,{label:"权限描述"},{default:r(()=>[i(f(s.value.description||"暂无描述"),1)]),_:1}),a(w,{label:"创建时间"},{default:r(()=>[i(f(_(F)(s.value.created_at)),1)]),_:1}),a(w,{label:"更新时间"},{default:r(()=>[i(f(_(F)(s.value.updated_at)),1)]),_:1})]),_:1}),s.value.id?(h(),R("div",et,[t[19]||(t[19]=c("h3",null,"拥有该权限的角色",-1)),a(me,{data:N.value,border:"",stripe:"",style:{width:"100%"}},{default:r(()=>[a(x,{prop:"name",label:"角色名称","min-width":"120"}),a(x,{prop:"code",label:"角色标识","min-width":"120"}),a(x,{prop:"created_at",label:"创建时间","min-width":"180"},{default:r(n=>[i(f(_(F)(n.row.created_at)),1)]),_:1}),a(x,{prop:"status",label:"状态",width:"100"},{default:r(n=>[a(H,{type:n.row.status?"success":"danger",size:"small"},{default:r(()=>[i(f(n.row.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):T("",!0)]),_:1})):T("",!0)])]),_:1}),a(ye,{modelValue:B.value,"onUpdate:modelValue":t[10]||(t[10]=n=>B.value=n),title:re.value,width:"600px","destroy-on-close":""},{footer:r(()=>[c("div",tt,[a(d,{onClick:t[9]||(t[9]=n=>B.value=!1)},{default:r(()=>t[22]||(t[22]=[i("取消")])),_:1}),a(d,{type:"primary",onClick:ie},{default:r(()=>t[23]||(t[23]=[i("确定")])),_:1})])]),default:r(()=>[a(ve,{ref_key:"permissionFormRef",ref:C,model:o,rules:oe,"label-width":"100px"},{default:r(()=>[b.value!=="edit"?(h(),S(V,{key:0,label:"父级权限"},{default:r(()=>[a(_e,{modelValue:o.parentId,"onUpdate:modelValue":t[3]||(t[3]=n=>o.parentId=n),options:le.value,props:{checkStrictly:!0,label:"name",value:"id",emitPath:!1,disabled:n=>!!n.isButton},placeholder:"请选择父级权限",clearable:""},null,8,["modelValue","options","props"])]),_:1})):T("",!0),a(V,{label:"权限名称",prop:"name"},{default:r(()=>[a(v,{modelValue:o.name,"onUpdate:modelValue":t[4]||(t[4]=n=>o.name=n),placeholder:"请输入权限名称"},null,8,["modelValue"])]),_:1}),a(V,{label:"权限标识",prop:"code"},{default:r(()=>[a(v,{modelValue:o.code,"onUpdate:modelValue":t[5]||(t[5]=n=>o.code=n),placeholder:"请输入权限标识",disabled:b.value==="edit"},null,8,["modelValue","disabled"])]),_:1}),a(V,{label:"权限类型",prop:"isButton"},{default:r(()=>[a(G,{modelValue:o.isButton,"onUpdate:modelValue":t[6]||(t[6]=n=>o.isButton=n)},{default:r(()=>[a(W,{value:!1},{default:r(()=>t[20]||(t[20]=[i("菜单权限")])),_:1}),a(W,{value:!0},{default:r(()=>t[21]||(t[21]=[i("按钮权限")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(V,{label:"权限描述",prop:"description"},{default:r(()=>[a(v,{modelValue:o.description,"onUpdate:modelValue":t[7]||(t[7]=n=>o.description=n),type:"textarea",placeholder:"请输入权限描述",rows:3},null,8,["modelValue"])]),_:1}),a(V,{label:"排序",prop:"sort"},{default:r(()=>[a(fe,{modelValue:o.sort,"onUpdate:modelValue":t[8]||(t[8]=n=>o.sort=n),min:0,max:999},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])])}}}),nt=Je(at,[["__scopeId","data-v-a97b2acf"]]);export{nt as default};
