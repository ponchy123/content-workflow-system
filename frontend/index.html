<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval'; worker-src 'self' blob:;">
    <!-- 添加禁止缓存的meta标签 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>物流运费计算系统</title>
    <script>
      // 更强大的模块加载错误处理
      (function() {
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          // 添加CORS请求头
          if (args[0] && typeof args[0] === 'string' && args[0].includes('/api/')) {
            if (!args[1]) {
              args[1] = {};
            }
            if (!args[1].headers) {
              args[1].headers = {};
            }
            args[1].headers = {
              ...args[1].headers,
              'X-Requested-With': 'XMLHttpRequest',
              // 添加CSRF Token头
              'X-CSRFToken': getCookie('csrftoken'),
              // 不要在客户端设置CORS头
            };
            // 确保跨域请求发送凭据
            args[1].credentials = 'include';
          }
          
          return originalFetch.apply(this, args).catch(err => {
            console.warn('拦截到fetch错误:', err.message);
            // 如果是模块加载错误，返回一个空模块
            if (args[0] && typeof args[0] === 'string' && args[0].includes('/workers/')) {
              console.warn('拦截到workers模块加载请求，返回空模块');
              return new Response('export default {}', {
                headers: { 'Content-Type': 'application/javascript' }
              });
            }
            return Promise.reject(err);
          });
        };
        
        // 获取cookie函数
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        
        // 处理所有错误
        window.addEventListener('error', function(e) {
          // 检查是否是模块加载错误
          if (e.message && (
            e.message.includes('Failed to load module script') || 
            e.message.includes('MIME type') ||
            e.message.includes('workers')
          )) {
            console.warn('拦截到模块加载错误:', e.message);
            // 防止错误传播
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }, true);
        
        // 处理未处理的promise rejection
        window.addEventListener('unhandledrejection', function(e) {
          if (e.reason && 
              (e.reason.message && 
               (e.reason.message.includes('Failed to load module script') || 
                e.reason.message.includes('MIME type') ||
                e.reason.message.includes('workers')))) {
            console.warn('拦截到未处理的Promise rejection:', e.reason.message);
            e.preventDefault();
            return false;
          }
        });

        // 修改XMLHttpRequest以处理CORS
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
          const xhr = this;
          originalXHROpen.apply(xhr, arguments);
          
          if (url.includes('/api/')) {
            try {
              xhr.withCredentials = true;
              xhr.addEventListener('readystatechange', function() {
                if (xhr.readyState === 1) { // OPENED状态
                  try {
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    // 添加CSRF Token
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                  } catch (e) {
                    console.warn('设置请求头失败:', e);
                  }
                }
              });
            } catch (e) {
              console.warn('配置XMLHttpRequest失败:', e);
            }
          }
        };
      })();
    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html> 